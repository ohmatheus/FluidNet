name: C++ Engine CI

on:
  push:
    paths:
      - "engine/**"
      - ".github/workflows/engine-ci.yml"
  pull_request:
    paths:
      - "engine/**"
      - ".github/workflows/engine-ci.yml"
  workflow_dispatch:

jobs:
  format-check:
    name: Format Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format

      - name: Check C++ formatting
        working-directory: ./engine
        run: |
          FILES=$(find src include -type f \( -name '*.cpp' -o -name '*.hpp' \) 2>/dev/null || true)
          if [ -n "$FILES" ]; then
            echo "Checking formatting for:"
            echo "$FILES"
            if ! echo "$FILES" | xargs clang-format --dry-run --Werror; then
              echo ""
              echo "=== Formatting issues found. Showing diffs for each file: ==="
              echo ""
              for file in $FILES; do
                if ! clang-format "$file" | diff -u "$file" - > /dev/null 2>&1; then
                  echo "--- $file ---"
                  clang-format "$file" | diff -u "$file" - || true
                  echo ""
                fi
              done
              exit 1
            fi
          else
            echo "No C++ files found to format"
          fi

  build-and-lint:
    name: Build & Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build clang-tidy build-essential \
            libx11-dev libxrandr-dev libxinerama-dev \
            libxcursor-dev libxi-dev libgl1-mesa-dev

      - name: Download ONNX Runtime
        working-directory: ./engine/external
        run: |
          mkdir -p onnxruntime && cd onnxruntime
          wget -q https://github.com/microsoft/onnxruntime/releases/download/v1.23.2/onnxruntime-linux-x64-gpu-1.23.2.tgz
          tar -xzf onnxruntime-linux-x64-gpu-1.23.2.tgz --strip-components=1
          ls -la include/onnxruntime_cxx_api.h  # Verify extraction
          ls -la lib/libonnxruntime.so

      - name: Configure CMake (Debug)
        working-directory: ./engine
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build
        working-directory: ./engine
        run: cmake --build build

      - name: Run clang-tidy
        working-directory: ./engine
        run: |
          FILES=$(find src -type f -name '*.cpp' 2>/dev/null || true)
          if [ -n "$FILES" ]; then
            echo "Running clang-tidy on:"
            echo "$FILES"
            for file in $FILES; do
              echo "Checking $file..."
              clang-tidy $file -p build --format-style=file --use-color || exit 1
            done
          else
            echo "No C++ source files found to lint"
          fi

      - name: Test run
        working-directory: ./engine
        run: |
          echo "Testing engine executable..."
          ./build/fluid_engine || echo "Engine test run failed (expected if dependencies not available)"
